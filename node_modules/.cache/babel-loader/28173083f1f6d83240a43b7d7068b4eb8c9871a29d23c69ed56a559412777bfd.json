{"ast":null,"code":"// src/components/PatientTemplatesPage.js\nimport React,{useState,useEffect}from'react';import{useNavigate}from'react-router-dom';import axios from'axios';import'../styles/routineTemplates.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function PatientTemplatesPage(){const[instances,setInstances]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const navigate=useNavigate();useEffect(()=>{const token=localStorage.getItem('token');const storedUser=localStorage.getItem('user');// Validamos token y user\nif(!token||!storedUser||storedUser==='undefined'||storedUser==='null'){// Si no hay sesión válida, vamos al login\nnavigate('/login');return;}let user;try{user=JSON.parse(storedUser);}catch(e){console.error('Error parsing user from localStorage',e);// Limpiamos el user inválido\nlocalStorage.removeItem('user');navigate('/login');return;}// Petición al backend para traer las instancias asignadas\naxios.get(`/api/routines/instances/${user.id}`,{headers:{'x-auth-token':token}}).then(res=>{setInstances(res.data);}).catch(err=>{var _err$response,_err$response$data;setError((_err$response=err.response)!==null&&_err$response!==void 0&&(_err$response$data=_err$response.data)!==null&&_err$response$data!==void 0&&_err$response$data.message?err.response.data.message:err.message);}).finally(()=>{setLoading(false);});},[navigate]);// Marca/desmarca una actividad como completada\nconst markActivity=async(instanceId,idx,completed)=>{const token=localStorage.getItem('token');try{const res=await axios.post(`/api/routines/instances/${instanceId}/activities/${idx}`,{completed},{headers:{'x-auth-token':token}});setInstances(prev=>prev.map(inst=>inst._id===instanceId?{...inst,completedActivities:res.data.completedActivities}:inst));}catch(err){console.error(err);}};// Actualiza el estado de la rutina (completed / postponed)\nconst updateStatus=async(instanceId,status)=>{const token=localStorage.getItem('token');try{const res=await axios.put(`/api/routines/instances/${instanceId}/status`,{status},{headers:{'x-auth-token':token}});setInstances(prev=>prev.map(inst=>inst._id===instanceId?{...inst,status:res.data.status}:inst));}catch(err){console.error(err);}};if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"patient-assigns\",children:\"Cargando mis plantillas\\u2026\"});}if(error){return/*#__PURE__*/_jsxs(\"div\",{className:\"patient-assigns\",children:[\"Error: \",error]});}return/*#__PURE__*/_jsxs(\"div\",{className:\"patient-assigns\",children:[/*#__PURE__*/_jsx(\"h1\",{children:\"Mis Plantillas Asignadas\"}),instances.length===0?/*#__PURE__*/_jsx(\"p\",{children:\"A\\xFAn no tienes plantillas asignadas.\"}):instances.map(inst=>{const completed=inst.completedActivities||[];const total=inst.template.activities.length;const doneCount=completed.length;const allDone=doneCount===total;return/*#__PURE__*/_jsxs(\"div\",{className:'assign-card '+(inst.status?'status-'+inst.status:''),children:[/*#__PURE__*/_jsx(\"h3\",{children:inst.template.name}),inst.assignedAt&&/*#__PURE__*/_jsxs(\"small\",{children:[\"Asignada el\",' ',new Date(inst.assignedAt).toLocaleDateString()]}),/*#__PURE__*/_jsx(\"p\",{children:inst.template.description}),/*#__PURE__*/_jsx(\"ul\",{children:inst.template.activities.map((act,idx)=>/*#__PURE__*/_jsx(\"li\",{children:/*#__PURE__*/_jsxs(\"label\",{children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:completed.includes(idx),onChange:()=>markActivity(inst._id,idx,!completed.includes(idx))}),act.name,\" (\",act.minutes,\" min)\",act.challenge&&` – Reto: ${act.challenge}`]})},idx))}),/*#__PURE__*/_jsxs(\"div\",{className:\"assign-actions\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn-complete\",onClick:()=>updateStatus(inst._id,'completed'),disabled:!allDone,children:\"Completar\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn-postpone\",onClick:()=>updateStatus(inst._id,'postponed'),disabled:allDone,children:\"Postergar\"})]})]},inst._id);})]});}","map":{"version":3,"names":["React","useState","useEffect","useNavigate","axios","jsx","_jsx","jsxs","_jsxs","PatientTemplatesPage","instances","setInstances","loading","setLoading","error","setError","navigate","token","localStorage","getItem","storedUser","user","JSON","parse","e","console","removeItem","get","id","headers","then","res","data","catch","err","_err$response","_err$response$data","response","message","finally","markActivity","instanceId","idx","completed","post","prev","map","inst","_id","completedActivities","updateStatus","status","put","className","children","length","total","template","activities","doneCount","allDone","name","assignedAt","Date","toLocaleDateString","description","act","type","checked","includes","onChange","minutes","challenge","onClick","disabled"],"sources":["C:/Users/User/Desktop/TFG/prototipo-TFG/Janus-TFG/src/components/PatientTemplatesPage.js"],"sourcesContent":["// src/components/PatientTemplatesPage.js\r\nimport React, { useState, useEffect } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport axios from 'axios';\r\nimport '../styles/routineTemplates.css';\r\n\r\nexport default function PatientTemplatesPage() {\r\n  const [instances, setInstances] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  const navigate = useNavigate();\r\n\r\n  useEffect(() => {\r\n    const token = localStorage.getItem('token');\r\n    const storedUser = localStorage.getItem('user');\r\n\r\n    // Validamos token y user\r\n    if (\r\n      !token ||\r\n      !storedUser ||\r\n      storedUser === 'undefined' ||\r\n      storedUser === 'null'\r\n    ) {\r\n      // Si no hay sesión válida, vamos al login\r\n      navigate('/login');\r\n      return;\r\n    }\r\n\r\n    let user;\r\n    try {\r\n      user = JSON.parse(storedUser);\r\n    } catch (e) {\r\n      console.error('Error parsing user from localStorage', e);\r\n      // Limpiamos el user inválido\r\n      localStorage.removeItem('user');\r\n      navigate('/login');\r\n      return;\r\n    }\r\n\r\n    // Petición al backend para traer las instancias asignadas\r\n    axios\r\n      .get(`/api/routines/instances/${user.id}`, {\r\n        headers: { 'x-auth-token': token }\r\n      })\r\n      .then(res => {\r\n        setInstances(res.data);\r\n      })\r\n      .catch(err => {\r\n        setError(\r\n          err.response?.data?.message\r\n            ? err.response.data.message\r\n            : err.message\r\n        );\r\n      })\r\n      .finally(() => {\r\n        setLoading(false);\r\n      });\r\n  }, [navigate]);\r\n\r\n  // Marca/desmarca una actividad como completada\r\n  const markActivity = async (instanceId, idx, completed) => {\r\n    const token = localStorage.getItem('token');\r\n    try {\r\n      const res = await axios.post(\r\n        `/api/routines/instances/${instanceId}/activities/${idx}`,\r\n        { completed },\r\n        { headers: { 'x-auth-token': token } }\r\n      );\r\n      setInstances(prev =>\r\n        prev.map(inst =>\r\n          inst._id === instanceId\r\n            ? { ...inst, completedActivities: res.data.completedActivities }\r\n            : inst\r\n        )\r\n      );\r\n    } catch (err) {\r\n      console.error(err);\r\n    }\r\n  };\r\n\r\n  // Actualiza el estado de la rutina (completed / postponed)\r\n  const updateStatus = async (instanceId, status) => {\r\n    const token = localStorage.getItem('token');\r\n    try {\r\n      const res = await axios.put(\r\n        `/api/routines/instances/${instanceId}/status`,\r\n        { status },\r\n        { headers: { 'x-auth-token': token } }\r\n      );\r\n      setInstances(prev =>\r\n        prev.map(inst =>\r\n          inst._id === instanceId ? { ...inst, status: res.data.status } : inst\r\n        )\r\n      );\r\n    } catch (err) {\r\n      console.error(err);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"patient-assigns\">\r\n        Cargando mis plantillas…\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"patient-assigns\">\r\n        Error: {error}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"patient-assigns\">\r\n      <h1>Mis Plantillas Asignadas</h1>\r\n\r\n      {instances.length === 0 ? (\r\n        <p>Aún no tienes plantillas asignadas.</p>\r\n      ) : (\r\n        instances.map(inst => {\r\n          const completed = inst.completedActivities || [];\r\n          const total = inst.template.activities.length;\r\n          const doneCount = completed.length;\r\n          const allDone = doneCount === total;\r\n\r\n          return (\r\n            <div\r\n              key={inst._id}\r\n              className={\r\n                'assign-card ' +\r\n                (inst.status ? 'status-' + inst.status : '')\r\n              }\r\n            >\r\n              <h3>{inst.template.name}</h3>\r\n              {inst.assignedAt && (\r\n                <small>\r\n                  Asignada el{' '}\r\n                  {new Date(inst.assignedAt).toLocaleDateString()}\r\n                </small>\r\n              )}\r\n              <p>{inst.template.description}</p>\r\n\r\n              <ul>\r\n                {inst.template.activities.map((act, idx) => (\r\n                  <li key={idx}>\r\n                    <label>\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={completed.includes(idx)}\r\n                        onChange={() =>\r\n                          markActivity(\r\n                            inst._id,\r\n                            idx,\r\n                            !completed.includes(idx)\r\n                          )\r\n                        }\r\n                      />\r\n                      {act.name} ({act.minutes} min)\r\n                      {act.challenge && ` – Reto: ${act.challenge}`}\r\n                    </label>\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n\r\n              <div className=\"assign-actions\">\r\n                <button\r\n                  className=\"btn-complete\"\r\n                  onClick={() =>\r\n                    updateStatus(inst._id, 'completed')\r\n                  }\r\n                  disabled={!allDone}\r\n                >\r\n                  Completar\r\n                </button>\r\n                <button\r\n                  className=\"btn-postpone\"\r\n                  onClick={() =>\r\n                    updateStatus(inst._id, 'postponed')\r\n                  }\r\n                  disabled={allDone}\r\n                >\r\n                  Postergar\r\n                </button>\r\n              </div>\r\n            </div>\r\n          );\r\n        })\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"AAAA;AACA,MAAO,CAAAA,KAAK,EAAIC,QAAQ,CAAEC,SAAS,KAAQ,OAAO,CAClD,OAASC,WAAW,KAAQ,kBAAkB,CAC9C,MAAO,CAAAC,KAAK,KAAM,OAAO,CACzB,MAAO,gCAAgC,CAAC,OAAAC,GAAA,IAAAC,IAAA,CAAAC,IAAA,IAAAC,KAAA,yBAExC,cAAe,SAAS,CAAAC,oBAAoBA,CAAA,CAAG,CAC7C,KAAM,CAACC,SAAS,CAAEC,YAAY,CAAC,CAAGV,QAAQ,CAAC,EAAE,CAAC,CAC9C,KAAM,CAACW,OAAO,CAAEC,UAAU,CAAC,CAAGZ,QAAQ,CAAC,IAAI,CAAC,CAC5C,KAAM,CAACa,KAAK,CAAEC,QAAQ,CAAC,CAAGd,QAAQ,CAAC,IAAI,CAAC,CACxC,KAAM,CAAAe,QAAQ,CAAGb,WAAW,CAAC,CAAC,CAE9BD,SAAS,CAAC,IAAM,CACd,KAAM,CAAAe,KAAK,CAAGC,YAAY,CAACC,OAAO,CAAC,OAAO,CAAC,CAC3C,KAAM,CAAAC,UAAU,CAAGF,YAAY,CAACC,OAAO,CAAC,MAAM,CAAC,CAE/C;AACA,GACE,CAACF,KAAK,EACN,CAACG,UAAU,EACXA,UAAU,GAAK,WAAW,EAC1BA,UAAU,GAAK,MAAM,CACrB,CACA;AACAJ,QAAQ,CAAC,QAAQ,CAAC,CAClB,OACF,CAEA,GAAI,CAAAK,IAAI,CACR,GAAI,CACFA,IAAI,CAAGC,IAAI,CAACC,KAAK,CAACH,UAAU,CAAC,CAC/B,CAAE,MAAOI,CAAC,CAAE,CACVC,OAAO,CAACX,KAAK,CAAC,sCAAsC,CAAEU,CAAC,CAAC,CACxD;AACAN,YAAY,CAACQ,UAAU,CAAC,MAAM,CAAC,CAC/BV,QAAQ,CAAC,QAAQ,CAAC,CAClB,OACF,CAEA;AACAZ,KAAK,CACFuB,GAAG,CAAC,2BAA2BN,IAAI,CAACO,EAAE,EAAE,CAAE,CACzCC,OAAO,CAAE,CAAE,cAAc,CAAEZ,KAAM,CACnC,CAAC,CAAC,CACDa,IAAI,CAACC,GAAG,EAAI,CACXpB,YAAY,CAACoB,GAAG,CAACC,IAAI,CAAC,CACxB,CAAC,CAAC,CACDC,KAAK,CAACC,GAAG,EAAI,KAAAC,aAAA,CAAAC,kBAAA,CACZrB,QAAQ,CACN,CAAAoB,aAAA,CAAAD,GAAG,CAACG,QAAQ,UAAAF,aAAA,YAAAC,kBAAA,CAAZD,aAAA,CAAcH,IAAI,UAAAI,kBAAA,WAAlBA,kBAAA,CAAoBE,OAAO,CACvBJ,GAAG,CAACG,QAAQ,CAACL,IAAI,CAACM,OAAO,CACzBJ,GAAG,CAACI,OACV,CAAC,CACH,CAAC,CAAC,CACDC,OAAO,CAAC,IAAM,CACb1B,UAAU,CAAC,KAAK,CAAC,CACnB,CAAC,CAAC,CACN,CAAC,CAAE,CAACG,QAAQ,CAAC,CAAC,CAEd;AACA,KAAM,CAAAwB,YAAY,CAAG,KAAAA,CAAOC,UAAU,CAAEC,GAAG,CAAEC,SAAS,GAAK,CACzD,KAAM,CAAA1B,KAAK,CAAGC,YAAY,CAACC,OAAO,CAAC,OAAO,CAAC,CAC3C,GAAI,CACF,KAAM,CAAAY,GAAG,CAAG,KAAM,CAAA3B,KAAK,CAACwC,IAAI,CAC1B,2BAA2BH,UAAU,eAAeC,GAAG,EAAE,CACzD,CAAEC,SAAU,CAAC,CACb,CAAEd,OAAO,CAAE,CAAE,cAAc,CAAEZ,KAAM,CAAE,CACvC,CAAC,CACDN,YAAY,CAACkC,IAAI,EACfA,IAAI,CAACC,GAAG,CAACC,IAAI,EACXA,IAAI,CAACC,GAAG,GAAKP,UAAU,CACnB,CAAE,GAAGM,IAAI,CAAEE,mBAAmB,CAAElB,GAAG,CAACC,IAAI,CAACiB,mBAAoB,CAAC,CAC9DF,IACN,CACF,CAAC,CACH,CAAE,MAAOb,GAAG,CAAE,CACZT,OAAO,CAACX,KAAK,CAACoB,GAAG,CAAC,CACpB,CACF,CAAC,CAED;AACA,KAAM,CAAAgB,YAAY,CAAG,KAAAA,CAAOT,UAAU,CAAEU,MAAM,GAAK,CACjD,KAAM,CAAAlC,KAAK,CAAGC,YAAY,CAACC,OAAO,CAAC,OAAO,CAAC,CAC3C,GAAI,CACF,KAAM,CAAAY,GAAG,CAAG,KAAM,CAAA3B,KAAK,CAACgD,GAAG,CACzB,2BAA2BX,UAAU,SAAS,CAC9C,CAAEU,MAAO,CAAC,CACV,CAAEtB,OAAO,CAAE,CAAE,cAAc,CAAEZ,KAAM,CAAE,CACvC,CAAC,CACDN,YAAY,CAACkC,IAAI,EACfA,IAAI,CAACC,GAAG,CAACC,IAAI,EACXA,IAAI,CAACC,GAAG,GAAKP,UAAU,CAAG,CAAE,GAAGM,IAAI,CAAEI,MAAM,CAAEpB,GAAG,CAACC,IAAI,CAACmB,MAAO,CAAC,CAAGJ,IACnE,CACF,CAAC,CACH,CAAE,MAAOb,GAAG,CAAE,CACZT,OAAO,CAACX,KAAK,CAACoB,GAAG,CAAC,CACpB,CACF,CAAC,CAED,GAAItB,OAAO,CAAE,CACX,mBACEN,IAAA,QAAK+C,SAAS,CAAC,iBAAiB,CAAAC,QAAA,CAAC,+BAEjC,CAAK,CAAC,CAEV,CAEA,GAAIxC,KAAK,CAAE,CACT,mBACEN,KAAA,QAAK6C,SAAS,CAAC,iBAAiB,CAAAC,QAAA,EAAC,SACxB,CAACxC,KAAK,EACV,CAAC,CAEV,CAEA,mBACEN,KAAA,QAAK6C,SAAS,CAAC,iBAAiB,CAAAC,QAAA,eAC9BhD,IAAA,OAAAgD,QAAA,CAAI,0BAAwB,CAAI,CAAC,CAEhC5C,SAAS,CAAC6C,MAAM,GAAK,CAAC,cACrBjD,IAAA,MAAAgD,QAAA,CAAG,wCAAmC,CAAG,CAAC,CAE1C5C,SAAS,CAACoC,GAAG,CAACC,IAAI,EAAI,CACpB,KAAM,CAAAJ,SAAS,CAAGI,IAAI,CAACE,mBAAmB,EAAI,EAAE,CAChD,KAAM,CAAAO,KAAK,CAAGT,IAAI,CAACU,QAAQ,CAACC,UAAU,CAACH,MAAM,CAC7C,KAAM,CAAAI,SAAS,CAAGhB,SAAS,CAACY,MAAM,CAClC,KAAM,CAAAK,OAAO,CAAGD,SAAS,GAAKH,KAAK,CAEnC,mBACEhD,KAAA,QAEE6C,SAAS,CACP,cAAc,EACbN,IAAI,CAACI,MAAM,CAAG,SAAS,CAAGJ,IAAI,CAACI,MAAM,CAAG,EAAE,CAC5C,CAAAG,QAAA,eAEDhD,IAAA,OAAAgD,QAAA,CAAKP,IAAI,CAACU,QAAQ,CAACI,IAAI,CAAK,CAAC,CAC5Bd,IAAI,CAACe,UAAU,eACdtD,KAAA,UAAA8C,QAAA,EAAO,aACM,CAAC,GAAG,CACd,GAAI,CAAAS,IAAI,CAAChB,IAAI,CAACe,UAAU,CAAC,CAACE,kBAAkB,CAAC,CAAC,EAC1C,CACR,cACD1D,IAAA,MAAAgD,QAAA,CAAIP,IAAI,CAACU,QAAQ,CAACQ,WAAW,CAAI,CAAC,cAElC3D,IAAA,OAAAgD,QAAA,CACGP,IAAI,CAACU,QAAQ,CAACC,UAAU,CAACZ,GAAG,CAAC,CAACoB,GAAG,CAAExB,GAAG,gBACrCpC,IAAA,OAAAgD,QAAA,cACE9C,KAAA,UAAA8C,QAAA,eACEhD,IAAA,UACE6D,IAAI,CAAC,UAAU,CACfC,OAAO,CAAEzB,SAAS,CAAC0B,QAAQ,CAAC3B,GAAG,CAAE,CACjC4B,QAAQ,CAAEA,CAAA,GACR9B,YAAY,CACVO,IAAI,CAACC,GAAG,CACRN,GAAG,CACH,CAACC,SAAS,CAAC0B,QAAQ,CAAC3B,GAAG,CACzB,CACD,CACF,CAAC,CACDwB,GAAG,CAACL,IAAI,CAAC,IAAE,CAACK,GAAG,CAACK,OAAO,CAAC,OACzB,CAACL,GAAG,CAACM,SAAS,EAAI,YAAYN,GAAG,CAACM,SAAS,EAAE,EACxC,CAAC,EAfD9B,GAgBL,CACL,CAAC,CACA,CAAC,cAELlC,KAAA,QAAK6C,SAAS,CAAC,gBAAgB,CAAAC,QAAA,eAC7BhD,IAAA,WACE+C,SAAS,CAAC,cAAc,CACxBoB,OAAO,CAAEA,CAAA,GACPvB,YAAY,CAACH,IAAI,CAACC,GAAG,CAAE,WAAW,CACnC,CACD0B,QAAQ,CAAE,CAACd,OAAQ,CAAAN,QAAA,CACpB,WAED,CAAQ,CAAC,cACThD,IAAA,WACE+C,SAAS,CAAC,cAAc,CACxBoB,OAAO,CAAEA,CAAA,GACPvB,YAAY,CAACH,IAAI,CAACC,GAAG,CAAE,WAAW,CACnC,CACD0B,QAAQ,CAAEd,OAAQ,CAAAN,QAAA,CACnB,WAED,CAAQ,CAAC,EACN,CAAC,GAxDDP,IAAI,CAACC,GAyDP,CAAC,CAEV,CAAC,CACF,EACE,CAAC,CAEV","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}